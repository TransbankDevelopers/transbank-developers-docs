# Webpay

___

 <aside class="warning">
We have just published the new REST reference for services
from Transbank. We invite you to know it [here] (/ reference / webpay)
 </aside>

## Environments and Credentials

### Production environment

java
Configuration configuration = new Configuration ();
configuration.setEnvironment (Webpay.Environment.LIVE);
`` ''

`` `php
$ configuration = new Configuration ();
$ configuration-> setEnvironment ("PRODUCTION");
`` ''

csharp
var configuration = new Configuration ();
configuration.Environment = "PRODUCTION";
`` ''

Production endpoint URLs are hosted within
 <https://webpay3g.transbank.cl/>.

> The SDKs come pre-configured with Transbank certificates and validate
> automatically the answers. You just have to make sure you keep your SDK
> updated to prevent preconfigured certificates from expiring.
> Or you can also manually overwrite the Webpay certificate to use
> for validation:

java
configuration.setWebpayCert (
    "----- BEGIN CERTIFICATE ----- \ n" +
    "MIIEDzCCAvegAwIBAgIJAMaH4DFTKdnJMA0GCSqGSIb3DQEBCwUAMIGdMQswCQYD \ n" +
    "VQQGEwJDTDERMA8GA1UECAwIU2FudGlhZ28xETAPBgNVBAcMCFNhbnRpYWdvMRcw \ n" +
    ...
    "MX5lzVXafBH / sPd545fBH2J3xAY3jtP764G4M8JayOFzGB0 = \ n" +
    "----- END CERTIFICATE ----- \ n");
`` ''

`` `php
$ configuration-> setWebpayCert (
     "----- BEGIN CERTIFICATE ----- \ n".
    "MIIEDzCCAvegAwIBAgIJAMaH4DFTKdnJMA0GCSqGSIb3DQEBCwUAMIGdMQswCQYD \ n".
    "VQQGEwJDTDERMA8GA1UECAwIU2FudGlhZ28xETAPBgNVBAcMCFNhbnRpYWdvMRcw \ n".
    ...
    "MX5lzVXafBH / sPd545fBH2J3xAY3jtP764G4M8JayOFzGB0 = \ n".
    "----- END CERTIFICATE ----- \ n");
);
`` ''

csharp
configuration.WebpayCertPath = @ "C: \ Certs \ public-certificate-transbank.crt"
`` ''

To validate the responses generated by Transbank you must use a certificate
Webpay public. In [the GitHub repository
`transbank-webpay-credenciales`] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/)
you can find [the certificate
updated] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/tree/master/produccion).

### Integration Environment

java
configuration.setEnvironment (Webpay.Environment.TEST);
`` ''

`` `php
$ configuration-> setEnvironment ("INTEGRATION");
`` ''

csharp
configuration.Environment = "INTEGRATION";
`` ''

Integration endpoint URLs are hosted within
 <https://webpay3gint.transbank.cl/>.

See [documentation for test cards that work on
the integration environment] (/ documentation / how to start # environments).

### Trade Credentials

java
configuration.setCommerceCode ("597020000540");
configuration.setPrivateKey (
    "----- BEGIN RSA PRIVATE KEY ----- \ n" +
    ... +
    "----- END RSA PRIVATE KEY ----- \ n"
);
configuration.setPublicCert (
    "----- BEGIN CERTIFICATE ----- \ n" +
    ... +
    "----- END CERTIFICATE ----- \ n"
);
`` ''

`` `php
$ configuration-> setCommerceCode ("597020000540");
$ configuration-> setPrivateKey (
    "----- BEGIN RSA PRIVATE KEY ----- \ n".
    ...
    "----- END RSA PRIVATE KEY ----- \ n"
);
$ configuration-> setPublicCert (
    "----- BEGIN CERTIFICATE ----- \ n".
    ...
    "----- END CERTIFICATE ----- \ n"
);
`` ''

csharp
configuration.CommerceCode = "597020000540";
configuration.PrivateCertPfxPath = @ "C: /Path/to/private/Cert.pfx";
configuration.Password = "PfxPassword";
`` ''

All requests you make must be signed with your private key and
certificate sent to Transbank. These credentials must match the
commercial code used in each request.

 <aside class="notice">
Please note that your trade code (s) in production environment are not
equal to those delivered for the integration environment.
 </aside>

 <aside class="warning">
Unlike other SDKs, in .NET you must specify the path to a pfx or p12 file
which you must generate from your private key and public certificate.

You can look at the following link for a quick guide on how to generate your
own file: [Create pfx file using openssl] (https://www.ssl.com/how-to/create-a-pfx-p12-certificate-file-using-openssl/)
 </aside>

See [the documentation to generate a private key and a certificate
using openssl] (/ documentation / how to get started # credentials-in-webpay) yes
you still don't know how to do it.

In [the GitHub repository
`transbank-webpay-credenciales`] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/)
you will be able to find [updated merchant codes and certificates to test
in integration even if you don't have your own code yet
commerce] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/tree/master/integracion).

> The SDKs already include these commercial codes, certificates and private keys
which work in the integration environment, so you can get
> quickly a configuration ready to do your first tests in said
> environment:

java
Configuration configuration =
    Configuration.forTestingWebpayPlusNormal ();

Configuration configuration =
    Configuration.forTestingWebpayPlusCapture ();

Configuration configuration =
    Configuration.forTestingWebpayPlusMall ();

Configuration configuration =
    Configuration.forTestingWebpayOneClickNormal ();
`` ''

`` `php
$ configuration = Configuration :: forTestingWebpayPlusNormal ();

$ configuration = Configuration :: forTestingWebpayPlusCapture ();

$ configuration = Configuration :: forTestingWebpayPlusMall ();

$ configuration = Configuration :: forTestingWebpayOneClickNormal ();
`` ''

csharp
var configuration = Configuration.ForTestingWebpayPlusNormal ();

var configuration = Configuration.ForTestingWebpayPlusCapture ();

var configuration = Configuration.ForTestingWebpayPlusMall ();

var configuration = Configuration.ForTestingWebpayOneClickNormal ();
`` ''

## Webpay Plus Normal

java
WebpayNormal transaction =
    new Webpay (configuration) .getNormalTransaction ();
`` ''

`` `php
$ transaction =
    (new Webpay ($ configuration)) -> getNormalTransaction ();
`` ''

csharp
var transaction = new Webpay (configuration) .NormalTransaction;
`` ''

WSDL: `/ WSWebpayTransaction / cxf / WSWebpayService? Wsdl`

A normal authorization transaction (or normal transaction), corresponds to
a request for financial authorization of a credit card payment or
debit, where who makes the payment enters the merchant's site,
select products or services, and the entry associated with the card details
Credit or debit is done safely in Webpay.

### Flow in case of success

For the cardholder, the page flow for the transaction is the
following:

 <img class="td_img-night" src="/images/flujo-paginas-webpay.png" alt="Flujo de páginas Webpay Plus Normal">

From a technical point of view, the sequence is as follows:

 <img class="td_img-night" src="/images/diagrama-secuencia-webpay.png" alt="Diagrama de secuencia Webpay Plus Normal">

1. Once the goods or services have been selected, the cardholder decides to pay
   through Webpay.
2. The merchant initiates a transaction in Webpay, invoking the method
   `initTransaction ()`.
3. Webpay processes the request and delivers as a result of the operation on
   token of the transaction and redirect URL to which it should be
   redirect cardholder.
4. Commerce redirects the cardholder to Webpay, with the token of the
   transaction to the URL indicated in point 3. The redirection is carried out
   sending by POST method the token in variable `token_ws`.
5. The cardholder's web browser makes an HTTPS request to Webpay, at
   based on the redirect generated by the trade in point 4.
6. Webpay responds to the request by displaying the Webpay payment form.
   From this point the communication is between Webpay and the cardholder, without
   interfere with trade. The Webpay payment form displays, between
   other things, the amount of the transaction, trade information such as
   name and logo, payment options through credit or debit.
7. Cardholder enters card details, clicks pay in
   Webpay form.
8. Webpay processes the authorization request (first bank authentication
   and then the authorization of the transaction).
9. Once the authorization is resolved, Webpay returns control to the merchant,
   performing an HTTPS redirect to the transition page
   of the merchant, where the transaction token is sent by POST method
   in the variable `token_ws`. The trade must implement the reception of this
   variable.
10. The cardholder's web browser makes an HTTPS request to the
    merchant site, based on the redirect generated by Webpay in the
    point 9.
11. The merchant site receives the `token_ws` variable and invokes the second one
    Web method, `getTransactionResult ()` (while displaying the
    transition), to obtain the authorization result. It is recommended
    that the result of the authorization is persisted in the systems of the
    trade, as this method can be invoked only once per
    transaction.
12. Commerce receives the result of the method invocation
    `getTransactionResult ()`.
13. For the merchant to inform Webpay that the result of the transaction is
    has received without problems, the trading system must consume the third
    method `acknowledgeTransaction ()`. If this was executed correctly the
    product can be released to the customer.

    > Los SDKs consumen `acknowledgeTransaction()` de manera automática, tan pronto
    > reciben una respuesta de `getTransactionResult()`.

    <aside class="warning">
    De no ser consumido `acknowledgeTransaction()` o demorar más de 30 segundos en
    su consumo, Webpay realizará la reversa de la transacción, asumiendo que
    existieron problemas de comunicación. En este caso el método retorna una
    Excepción indicando la situación, el mensaje obtenido en la excepción será
    `Timeout error (Transaction is REVERSED)(272)`. Esta excepción debe ser manejada
    para no entregar el producto o servicio en caso que ocurra.
    </aside>

14. Once the result of the transaction has been received and Webpay informed of its
    correct reception, the merchant site must redirect the cardholder
    again to Webpay, in order to display the payment receipt.
    It is important to make this point so that the cardholder understands that
    the payment process was successful, and it will involve a charge to your card
    bank. The redirection to Webpay is done using the destination
    URL reported by `getTransactionResult ()` method sending by method
    POST the transaction token in the `token_ws` variable.
15. Webpay receives a request with the variable `token_ws`
16. Webpay identifies the transaction and displays the payment receipt at the
    cardholder.
17. Once the payment receipt has been viewed for a limited period of time,
    the cardholder is redirected back to the merchant's site, by means of
    redirect with the token in the token_ws variable sent by
    POST method to the final page reported by the merchant in the method
    initTransaction.
18. Commerce site displays final payment page

### Flow if user aborts payment

 <img class="td_img-night" src="/images/diagrama-secuencia-webpay-abortar.png" alt="Diagrama de secuencia si usuario aborta el pago">

If the cardholder cancels the transaction in the Webpay payment form,
the flow changes and the steps are as follows:

1. Once the goods or services have been selected, the cardholder decides to pay
   through Webpay.
2. The merchant initiates a transaction in Webpay, invoking the method
   `initTransaction ()`.
3. Webpay processes the request and delivers as a result of the operation on
   token of the transaction and redirect URL to which it should be
   redirect cardholder.
4. Commerce redirects the cardholder to Webpay, with the token of the
   transaction to the URL indicated in point 3. The redirection is carried out
   sending by POST method the token in variable `token_ws`.
5. The cardholder's web browser makes an HTTPS request to Webpay, at
   based on the redirect generated by the trade in point 4.
6. Webpay responds to the request by displaying the Webpay payment form.
   From this point the communication is between Webpay and the cardholder, without
   interfere with trade. The Webpay payment form displays, between
   other things, the amount of the transaction, trade information such as
   name and logo, payment options through credit or debit.
7. Cardholder clicks "void" in the Webpay form.
8. Webpay returns control to the merchant, performing a redirection
   HTTPS towards the ** end of trade ** page, where it is sent by
   POST method the transaction token in the variable `TBK_TOKEN` in addition to the variables` TBK_ORDEN_COMPRA` and `TBK_ID_SESION`.

    <aside class="warning">
    Nota que el nombre de las variables recibidas es diferente. En lugar de `token_ws` acá el token viene en la variable `TBK_TOKEN`.
    </aside>

9. Trading with the variable `TBK_TOKEN` should invoke the method
   `getTransactionResult ()`, to obtain the authorization result. In
   this case must get an exception (Timeout 272), since the payment was aborted.
10. The merchant must inform the cardholder that their payment was not completed.

### Other flows

It is important to highlight the following additional flows that should be considered:

1. Once the cardholder is redirected to the payment form, they have ** 10 minutes ** to complete it. After that time, Webpay closes the transaction automatically and redirects the user back to the merchant, sending him to the URL of _finish_ (page ** end of the merchant **). This time, unlike the flow when aborting with the 'Cancel transaction' button, the parameter `TBK_TOKEN` does not arrive, and only` TBK_ID_SESION` and `TBK_ORDEN_COMPRA` arrive.

2. If an error occurs while the cardholder is in the payment form (for example, if he closes the browser tab and tries to recover it or in other border cases), an error screen is displayed informing him that no charges have been made. and additionally presents a link to return to the site of the trade. When you click on this link, you are redirected to the URL of _finish_ (page ** end of the trade **). This time, unlike the previous cases, sending `TBK_TOKEN` and` token_ws` (both fields with the same token).
This case is important to note, since if the same URL is configured for `returnUrl` and` finishUrl` in the `initTransaction`, it is not possible to know if it is a failed payment flow that arrives directly at` finishUrl`, or if it is a normal flow and reached the `returnUrl` with a success / reject. ** For this reason, it is recommended to always have different URLs for `returnUrl` and` finishUrl`. **

### Create a Webpay Plus Normal transaction

To create a transaction, just call the `initTransaction ()` method

 <strong> initTransaction () </strong>

It allows to initialize a transaction in Webpay. In response to the invocation
a token is generated that uniquely represents a transaction.

 <aside class="notice">
It is important to consider that once this method is invoked, the token that is
delivered has a reduced life span of 5 minutes, after this the
token is expired and cannot be used in a payment.
 </aside>

java
WsInitTransactionOutput initResult =
    transaction.initTransaction (
        amount, sessionId, buyOrder, returnUrl, finalUrl);
`` ''

`` `php
$ initResult = $ transaction-> initTransaction (
        $ amount, $ buyOrder, $ sessionId, $ returnUrl, $ finalUrl);
`` ''

csharp
var initResult = transaction.initTransaction (
        amount, buyOrder, sessionId, returnUrl, finalUrl);
`` ''

 <strong> initTransaction parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
WSTransactionType <br> <i> wsTransactionType </i> | Indicates the type of transaction, its value must always be TR_NORMAL_WS for normal transactions. SDKs automatically take care of this parameter
sessionId <br> <i> xs: string </i> | (Optional) Session identifier, internal trade use, this value is returned at the end of the transaction. Maximum length: 61
returnURL <br> <i> xs: anyURI </i> | URL of the merchant, to which Webpay will redirect after the authorization process. Maximum length: 256
finalURL <br> <i> xs: anyURI </i> | URL of the merchant to which Webpay will redirect after the successful Webpay voucher. Maximum length 256
transactionDetails <br> <i> wsTransactionDetail </i> | List of objects of type wsTransactionDetail, which contains transaction data. For normal transactions it must contain exactly one element
transactionDetails [0] .amount <br> <i> xs: decimal </i> | Amount of the transaction. Maximum 2 decimal places for USD. Maximum length: 10
transactionDetails [0] .buyOrder <br> <i> xs: string </i> | Store purchase order. This number must be unique for each transaction. Maximum length: 26. The purchase order can have: Numbers, letters, upper and lower case, and the signs <code> & # 124; _ = &%., ~: /? [+! @ ()> - </code>
transactionDetails [0] .commerceCode <br> <i> xs: string </i> | Commercial code of the store delivered by Transbank. Length: 12, If the code you have is 8 digits you must prepend 5970. The SDKs automatically take care of this parameter from the merchant configuration and certificates / keys used to initiate the transaction

 <strong> initTransaction response </strong>

java
initResult.getToken ();
initResult.getUrl ();
`` ''

`` `php
$ initResult-> token;
$ initResult-> url;
`` ''

csharp
initResult.token;
initResult.url;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Token of the transaction. Length: 64.
url <br> <i> xs: string </i> | Webpay payment form URL. Maximum length: 256.

 <aside class="warning">
The purchase order number (`buyOrder`) must be unique for each transaction.
If a `buyOrder` is sent two or more times you will get the error` Transaction already exists (21) `
 </aside>

### Confirm a Webpay Plus Normal transaction

When the trade retakes control using `returnURL` you can confirm a
transaction using the `getTransactionResult ()` and
`acknowledgeTransaction ()`

 <strong> getTransactionResult () </strong>

It allows you to obtain the result of the transaction once Webpay has resolved your financial authorization.

java
TransactionResultOutput result =
    transaction.getTransactionResult (
        request.getParameter ("token_ws"));
`` ''

`` `php
$ result = transaction-> getTransactionResult (
    $ request-> input ("token_ws"));
`` ''

csharp
var result = transaction.getTransactionResult (tokenWs));
`` ''

 <strong> getTransactionResult parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> |Token of the transaction. Length: 64.

 <strong> getTransactionResult response </strong>

java

WsTransactionDetailOutput output =
    result.getDetailOutput (). get (0);
if (output.getResponseCode () == 0) {
    // Successful transaction, you can process the result
    // with the content of the result and output variables.
    result.getBuyOrder ();
    result.getSessionId ();
    result.getCardDetail (). getCardNumber ();
    result.getCardDetail (). getCardExpirationDate ();
    result.getAccountingDate ();
    result.getTransactionDate ();
    result.getVci ();
    result.getUrlRedirection ();
    output.getAuthorizationCode ();
    output.getPaymentType ();
    output.getAmount ();
    output.getSharesNumber ();
    output.getCommerceCode ();
    output.getBuyOrder ();
}
`` ''

`` `php
$ output = $ result-> detailOutput;
if ($ output-> responseCode == 0) {
    // Successful transaction, you can process the result
    // with the content of the $ result and $ output variables.
    $ result-> buyOrder;
    $ result-> sessionId;
    $ result-> cardDetail-> cardNumber;
    $ result-> cardDetail-> cardExpirationDate;
    $ result-> accountingDate;
    $ result-> transactionDate;
    $ result-> vci;
    $ result-> urlRedirection;
    $ output-> authorizationCode;
    $ output-> paymentType;
    $ output-> amount;
    $ output-> sharesNumber;
    $ output-> commerceCode;
    $ output-> buyOrder;
}
`` ''

csharp
var output = result.detailOutput [0]
if (output.responseCode == 0) {
    // Successful transaction, you can process the result
    // with the content of the result and output variables.
    result.buyOrder;
    result.sessionId;
    result.cardDetail.cardNumber;
    result.cardDetail.cardExpirationDate;
    result.accountingDate;
    result.transactionDate;
    result.vci;
    result.urlRedirection;
    output.authorizationCode;
    output.paymentType;
    output.amount;
    output.sharesNumber;
    output.commerceCode;
    output.buyOrder;
}
`` ''

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: string </i> | Purchase order from the store indicated in `initTransaction ()`. Maximum length: 26
sessionId <br> <i> xs: string </i> |Session identifier, the same one originally sent by the merchant in `initTransaction ()`. Maximum length: 61.
cardDetails <br> <i> carddetails </i> | Object that represents the cardholder's credit card data.
cardDetails.cardNumber <br> <i> xs: string </i> |Last 4 numbers of the cardholder's credit card. Only for businesses authorized by Transbank is the full number sent. Maximum length: 16.
cardDetails.cardExpirationDate <br> <i> xs: string </i> |(Optional) Expiration date of the cardholder's credit card. YYMM format Only for businesses authorized by Transbank. Maximum length: 4
accountingDate <br> <i> xs: string </i> | Authorization date. Length: 4, MMDD format
transactionDate <br> <i> xs: string </i> | Date and time of authorization. Length: 6, format: MMDDHHmm
VCI <br> <i> xs: string </i> | Result of cardholder authentication. It can take the value: <br> TSY = Authentication successful <br> TSN = Authentication failed <br> TO = Maximum time exceeded for authentication <br> ABO = Authentication aborted by cardholder a0342fccfda was probably a foreign cardholder a0342fccfda0342fccfda a0342fccfda was not participating in internal authentication a19bzfda019 that does not participate in the 3DSecure program <br> ACS2 = Foreign authentication failed <br> A = Authentication attempt <br> INV = Invalid authentication <br> EOP = Operational error a0342fccfda19b could not be authenticated if transaction was empty. Maximum length: 3. This field is supplementary additional information to the `responseCode` but the merchant ** does not ** have to validate this field. Because new authentication mechanisms are constantly being added that translate into new values for this field that are not necessarily documented. (In the case of international cards that do not provide 3D-Secure, the merchant's decision to accept them or not is made at the merchant's configuration level in Transbank and must be discussed with the merchant's executive)
urlRedirection <br> <i> xs: string </i> | Redirect URL for voucher display. Maximum length: 256
detailsOutput <br> <i> wsTransactionDetailOutput </i> | List with result of each of the `transactionDetails` sent in` initTransaction () `. For Webpay Plus Normal you have a maximum of one item.
detailsOutput [0] .authorizationCode <br> <i> xs: string </i> | Transaction authorization code Maximum length: 6
detailsOutput [0] .paymentTypeCode <br> <i> xs: string </i> | [Payment type] (/ product / webpay # payment-types) of the transaction. <br> VD = Sale Debit. <br> VN = Normal Sale. <br> VC = Sale in installments. <br> SI = 3 installments without interest. <br> S2 = 2 installments without interest. <br> NC = N Installments without interest <br> VP = Prepaid Sale.
detailsOutput [0] .responseCode <br> <i> xs: string </i> | Authorization response code. Possible values: <br> 0 = Transaction approved <br> -1 = Transaction rejection - Retry <i> (Possible error in the transaction data entry) </i> <br> -2 = This transaction failed01fccfda1927bze0 -2 was processed by transaction failure01fc rejection is related to parameters of the card and / or its associated account) </i> <br> -3 = Error transaction <i> (Internal TransBank) -4 </i> <br> = rejection emitter <i> (rejected by the issuer) -5 <br> </i> = rejection - Possible Fraud <i> (Transaction with risk of possible fraud) </i> <br>
detailsOutput [0] .amount <br> <i> Integer format for weight transactions and decimal for dollar transactions. </i> | Amount of the transaction. Maximum length: 10
detailsOutput [0] .sharesNumber <br> <i> xs: int </i> | Amount of fees. Maximum length: 2
detailsOutput [0] .commerceCode <br> <i> xs: string </i> | Store trade code. Length: 12
detailsOutput [0] .buyOrder <br> <i> xs: string </i> | Store purchase order. Maximum length: 26

 <strong> acknowledgeTransaction () </strong>

Indicates to Webpay that the result of the transaction has been received.

 <aside class="warning">
The acknowledgeTransaction method must always be called. If the invocation
is not done within 30 seconds, Webpay will reverse the transaction,
assuming the trade was unable to report its result, thus avoiding the
charge to the cardholder.
 </aside>

 <strong> acknowledgeTransaction parameters </strong>

> SDKs automatically execute `acknowledgeTransaction ()` when they receive the
> response from `getTransactionResult ()`.

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> | Token of the transaction. Length: 64.

 <strong> AcknowledgeTransaction Response </strong>

SDKs will throw exception inside `getTransactionResult ()` if it fails
> the `acknowledgeTransaction ()` which is executed automatically.

None.

 <aside class="warning">
In case of calling the acknowledgeTransaction method after 30 seconds of
Once the authorization has occurred, the exception described below will be reported and the
The merchant must not deliver product or service, since the transaction has been
Reversed by Webpay: Timeout error (Transactions REVERSED) with code 277.
 </aside>

## Webpay Plus Mall

java
WebpayMallNormal transaction =
    new Webpay (configuration) .getMallNormalTransaction ();
`` ''

`` `php
$ transaction =
    (new Webpay (configuration)) -> getMallNormalTransaction ();
`` ''

csharp
var transaction =
    new Webpay (configuration) .MallNormalTransaction;
`` ''

WSDL: `/ WSWebpayTransaction / cxf / WSWebpayService? Wsdl`

A Mall Normal transaction corresponds to an authorization request
financial of a set of payments with credit or debit cards, where
who makes the payment enters the merchant's site, selects products or
services, and the income associated with the credit or debit card details
You do it once in a secure way in Webpay for all payments.
Each payment will have its own result, authorized or rejected.

! [Disaggregation of a Webpay Mall payment] (/ images / pago-webpay-mall.png)

The Webpay Mall groups multiple stores, it is the latter that can
generate transactions. Both the mall and associated stores are
identified through a number called the commercial code.

### Webpay Plus Mall Flow

The flow of Webpay Plus Mall is generally the same as that of [Webpay Plus
Normal] (# webpay-plus-normal) both for the cardholder and for the
integrator.

The difference are:

* A merchant code configured for Mall mode must be used in
  Transbank, which must be indicated when initiating the transaction.
* Multiple transactions can be indicated, each associated with a code of
  store trade (which must be configured in Transbank as belonging to
  to the mall).
* The result of each of these transactions must be verified separately
  individually, as the card issuer may authorize some
  and others not.

### Create a Webpay Plus Mall transaction

To create a transaction, just call the `initTransaction ()` method

 <strong> initTransaction () Mall </strong>

It allows to initialize a transaction in Webpay. In response to the invocation
a token is generated that uniquely represents a transaction.

 <aside class="notice">
It is important to consider that once this method is invoked, the token that is
delivered has a reduced life span of 5 minutes, after this the
token is expired and cannot be used in a payment.
 </aside>

java
WsTransactionDetail storeTransaction = new WsTransactionDetail ();
List <WsTransactionDetail> transactions = new ArrayList <> ();

storeTransaction.setAmount (amount);
storeTransaction.setCommerceCode (storeCode);
storeTransaction.setBuyOrder (storeBuyOrder);
transactions.add (storeTransaction);

storeTransaction.setAmount (anotherAmount);
storeTransaction.setCommerceCode (anotherStoreCode);
storeTransaction.setBuyOrder (anotherStoreBuyOrder);
transactions.add (storeTransaction);

WsInitTransactionOutput initResult = transaction.initTransaction (
    buyOrder, sessionId, returnUrl, finalUrl, transactions);
`` ''

`` `php
$ transactions = array ();
$ transactions [] = array (
    "storeCode" => $ storeCode,
    "amount" => $ amount,
    "buyOrder" => $ buyOrder,
    "sessionId" => $ sessionId
)
$ transactions [] = array (
    "storeCode" => $ anotherStoreCode,
    "amount" => $ anotherAmount,
    "buyOrder" => $ anotherBuyOrder,
    "sessionId" => $ anotherSessionId
)

$ initResult = $ transaction-> initTransaction (
    $ buyOrder, $ sessionId, $ returnUrl, $ finalUrl, $ transactions);
`` ''

csharp
var transactions = new Dictionary <string, string[]> ();

transactions.Add (storeCode,
    new string [] {storeCode, amount});
transactions.Add (anotherStoreCode,
    new string [] {anotherStoreCode, anotherAmount});

var initResult = transaction.initTransaction (
    buyOrder, sessionId, returnUrl, finalUrl, transactions);
`` ''

 <strong> initTransaction Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
WSTransactionType <br> <i> wsTransactionType </i> | Indicates the type of transaction, its value must always be TR_MALL_WS for mall transactions. SDKs automatically take care of this parameter.
sessionId <br> <i> xs: string </i> | (Optional) Session identifier, internal trade use, this value is returned at the end of the transaction. Maximum length: 61
returnURL <br> <i> xs: anyURI </i> | Merchant URL, to which Webpay will redirect after the authorization process Maximum length: 256.
finalURL <br> <i> xs: anyURI </i> | URL of the merchant to which Webpay will redirect after the successful Webpay voucher. Maximum length 256.
buyOrder <br> <i> xs: string </i> | It is the unique code of the purchase order generated by the mall trade.
transactionDetails <br> <i> wsTransactionDetail </i> | List of objects of type wsTransactionDetail, one for each different store in the mall that participates in the transaction.
transactionDetails []. amount <br> <i> xs: decimal </i> | Amount of the transaction of a mall store. Maximum 2 decimal places for USD. Maximum length: 10.
transactionDetails []. buyOrder <br> <i> xs: string </i> | Purchase order from the mall store. This number must be unique for each transaction. Maximum length: 26. The purchase order can have: Numbers, letters, uppercase and lowercase, and the signs <code> & # 124; _ = &%., ~: /? [+! @ ()> - </code>.
transactionDetails []. commerceCode <br> <i> xs: string </i> | Trade code assigned by Transbank for the store belonging to the mall to which this transaction corresponds. Length: 12. <br> If the code you have is 8 digits you must prepend 5970.

 <strong> initTransaction Mall Response </strong>

java
initResult.getToken ();
initResult.getUrl ();
`` ''

`` `php
$ initResult-> token;
$ initResult-> url;

`` ''

csharp
initResult.token;
initResult.url;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Token of the transaction. Length: 64.
url <br> <i> xs: string </i> | Webpay payment form URL. Maximum length: 256.

 <aside class="warning">
The purchase order number (`buyOrder`) must be unique for each transaction.
If a `buyOrder` is sent two or more times you will get the error` Transaction already exists (21) `
 </aside>

### Confirm a Webpay Plus Mall transaction

To commit a transaction you must use the `getTransactionResult ()` and
`acknowledgeTransaction ()`

 <strong> getTransactionResult () Mall </strong>

It allows to obtain the result of the transaction once Webpay has resolved
your financial authorization.

java
TransactionResultOutput result =
    transaction.getTransactionResult (
        request.getParameter ("token_ws"));
`` ''

`` `php
$ result = transaction-> getTransactionResult (
    $ request-> input ("token_ws"));
`` ''

csharp
var result = transaction.getTransactionResult (tokenWs));
`` ''

 <strong> getTransactionResult Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> |Token of the transaction. Length: 64.

 <strong> getTransactionResult Mall Response </strong>

java
for (WsTransactionDetailOutput output: result.getDetailOutput ()) {
    // Each transaction of each store in the
    // mall separately:
    if (output.getResponseCode () == 0) {
        // Successful transaction, you can process the result
        // with the content of the result and output variables.
        output.getAuthorizationCode ();
        output.getPaymentType ();
        output.getAmount ();
        output.getSharesNumber ();
        output.getCommerceCode ();
        output.getBuyOrder ();
    }
}
result.getBuyOrder ();
result.getSessionId ();
result.getCardDetail (). getCardNumber ();
result.getCardDetail (). getCardExpirationDate ();
result.getAccountingDate ();
result.getTransactionDate ();
result.getVci ();
result.getUrlRedirection ();
`` ''

`` `php
foreach ($ result-> detailOutput as $ output) {
    // Each transaction of each store in the
    // mall separately:
    if ($ output-> responseCode == 0) {
        // Successful transaction, you can process the result
        // with the content of the result and output variables.
        output-> authorizationCode;
        output-> paymentType;
        output-> amount;
        output-> sharesNumber;
        output-> commerceCode;
        output-> buyOrder;
    }
}
result-> buyOrder;
result-> sessionId;
result-> cardDetail-> cardNumber;
result-> cardDetail-> cardExpirationDate;
result-> accountingDate;
result-> transactionDate;
result-> vci;
result-> urlRedirection;
`` ''

csharp
foreach (var output in result.detailOutput) {
    // Each transaction of each store in the
    // mall separately:
    if (output.responseCode == 0) {
        // Successful transaction, you can process the result
        // with the content of the result and output variables.
        output.authorizationCode;
        output.paymentType;
        output.amount;
        output.sharesNumber;
        output.commerceCode;
        output.buyOrder;
    }
}
result.buyOrder;
result.sessionId;
result.cardDetail.cardNumber;
result.cardDetail.cardExpirationDate;
result.accountingDate;
result.transactionDate;
result.vci;
result.urlRedirection;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: string </i> | Purchase order from the mall. Maximum length: 26
sessionId <br> <i> xs: string </i> |Session identifier, the same one originally sent by the merchant in `initTransaction ()`. Maximum length: 61.
cardDetails <br> <i> carddetails </i> | Object that represents the cardholder's credit card data.
cardDetails.cardNumber <br> <i> xs: string </i> |Last 4 numbers of the cardholder's credit card. Only for merchants authorized by Transbank the full number is sent. Maximum length: 16.
cardDetails.cardExpirationDate <br> <i> xs: string </i> |(Optional) Expiration date of the cardholder's credit card. YYMM format Only for businesses authorized by Transbank. Maximum length: 4
accoutingDate <br> <i> xs: string </i> | Authorization date. Length: 4, MMDD format
transactionDate <br> <i> xs: string </i> | Date and time of authorization. Length: 6, format: MMDDHHmm
VCI <br> <i> xs: string </i> | Result of cardholder authentication. It can take the value: <br> TSY = Authentication successful <br> TSN = Authentication failed <br> TO = Maximum time exceeded for authentication <br> ABO = Authentication aborted by cardholder a0342fccfda was probably a foreign cardholder a0342fccfda0342fccfda a0342fccfda was not participating in internal authentication a19bzfda019 that does not participate in the 3DSecure program <br> ACS2 = Foreign authentication failed <br> A = Authentication attempt <br> INV = Invalid authentication <br> EOP = Operational error a0342fccfda19b could not be authenticated if transaction was empty. Maximum length: 3. This field is supplementary additional information to the `responseCode` but the merchant ** does not ** have to validate this field. Because new authentication mechanisms are constantly being added that translate into new values for this field that are not necessarily documented. (In the case of international cards that do not provide 3D-Secure, the merchant's decision to accept them or not is made at the merchant's configuration level in Transbank and must be discussed with the merchant's executive)
urlRedirection <br> <i> xs: string </i> | Redirect URL for voucher display. Maximum length: 256
detailsOutput <br> <i> wsTransactionDetailOutput </i> | List with result of each of the `transactionDetails` sent in` initTransaction () `.
detailsOutput []. authorizationCode <br> <i> xs: string </i> | Transaction authorization code Maximum length: 6
detailsOutput []. paymentTypeCode <br> <i> xs: string </i> | [Payment type] (/ product / webpay # payment-types) of the transaction. <br> VD = Sale Debit. <br> VN = Normal Sale. <br> VC = Sale in installments. <br> SI = 3 installments without interest. <br> S2 = 2 installments without interest. <br> NC = N Installments without interest <br> VP = Prepaid Sale.
detailsOutput []. responseCode <br> <i> xs: string </i> | Authorization response code. Possible values: <br /> 0 = Transaction approved <br> -1 = Transaction rejection - Retry <i> (Possible error in transaction data entry) </i> <br> -1 = This transaction failed to process02cfda19bz0 = This transaction failed to process02cz049z0e0ec02. rejection is related to parameters of the card and / or its associated account) </i> <br> -3 = Error transaction <i> (Internal TransBank) -4 </i> <br> = rejection emitter <i> (rejected by the issuer) -5 <br> </i> = rejection - Possible Fraud <i> (Transaction with risk of possible fraud) </i> <br>
detailsOutput []. amount <br> <i> Integer format for weight transactions and decimal for dollar transactions. </i> | Amount of the transaction. Maximum length: 10
detailsOutput []. sharesNumber <br> <i> xs: int </i> | Amount of fees. Maximum length: 2
detailsOutput []. commerceCode <br> <i> xs: string </i> | Store trade code. Length: 12
detailsOutput []. buyOrder <br> <i> xs: string </i> | Store purchase order. Maximum length: 26

 <strong> acknowledgeTransaction () Mall </strong>

Indicates to Webpay that the result of the transaction has been received.

 <aside class="warning">
The acknowledgeTransaction method must always be called. If the invocation
is not done within 30 seconds, Webpay will reverse the transaction,
assuming the trade was unable to report its result, thus avoiding the
charge to the cardholder.
 </aside>

 <strong> acknowledgeTransaction Mall parameters </strong>

> SDKs automatically execute `acknowledgeTransaction ()` when they receive the
> response from `getTransactionResult ()`.

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> | Token of the transaction. Length: 64.

 <strong> Reply acknowledgeTransaction Mall </strong>

SDKs will throw exception inside `getTransactionResult ()` if it fails
> the `acknowledgeTransaction ()` which is executed automatically.

None.

 <aside class="warning">
In case of calling the acknowledgeTransaction method after 30 seconds of
Once the authorization has occurred, the exception described below will be reported and the
The merchant must not deliver product or service, since the transaction has been
Reversed by Webpay: Timeout error (Transactions REVERSED) with code 277.
 </aside>

## Other Webpay Plus Services

WSDL: `/ WSWebpayTransaction / cxf / WSCommerceIntegrationService? Wsdl`

### Delayed capture Webpay Plus

This method allows all authorized merchants to capture a
Authorized transaction without capture generated in Webpay Plus or Oneclick.
The method contemplates a single capture for each authorization. For this I
You must indicate the data associated with the sale transaction with authorization
no catch and the amount required to catch which must be less than or equal to the
originally authorized amount.

Executions with errors will return a `SoapFault` according to the
error coding defined below.

To capture a transaction, it must have been created (as seen
above for Webpay Plus Normal or Webpay Plus Mall) by a code of
trade configured for deferred capture. That way the transaction will be
authorized but will require a later explicit capture to confirm the
transaction.

You can [read more about the capture in the information of the
Webpay product] (/ product / webpay # authorization-and-capture)
for more details and restrictions.

To make this explicit capture, the `capture ()` method must be used

 <strong> capture () </strong>

Allows you to request from Webpay the deferred capture of a transaction with
authorization and without simultaneous capture.

> The SDKs allow you to optionally indicate the commercial code of the
> transaction to capture, to support capture in Webpay Plus merchants
> Mall. In Webpay Plus Normal stores, it is not necessary to specify the code
> Trade as the one indicated in the configuration is used.

 <aside class="notice">
The `capture ()` method must be invoked always indicating the code of the
merchant that carried out the transaction. In the case of Webpay Plus Mall stores,
the code must be the code of the specific virtual store.
 </aside>

java
WebpayCapture transaction =
    new Webpay (configuration) .getCaptureTransaction ();

// For Webpay Plus Normal merchants
CaptureOutput captureResult = transaction.capture (
    authorizationCode, capturedAmount, buyOrder);

// For Webpay Plus Mall merchants
CaptureOutput captureResult = transaction.capture (
    authorizationCode, capturedAmount, buyOrder, storeCommerceCode);
`` ''

`` `php
$ transaction = (new Webpay (configuration)) -> getCaptureTransaction ();

// For Webpay Plus Normal merchants
$ captureResult = transaction.capture (
    $ authorizationCode, $ capturedAmount, $ buyOrder);

// For Webpay Plus Mall merchants
$ captureResult = transaction.capture (
    $ authorizationCode, $ capturedAmount, $ buyOrder, $ storeCommerceCode);
`` ''

csharp
var transaction = new Webpay (configuration) .CaptureTransaction;

// For Webpay Plus Normal merchants
var captureResult = transaction.capture (
    authorizationCode, capturedAmount, buyOrder);

// For Webpay Plus Mall merchants
var captureResult = transaction.capture (
    authorizationCode, capturedAmount, buyOrder, storeCommerceCode);

`` ''

 <strong> Parameters capture </strong>

Name <br> <i> type </i> | Description
------   | -----------
authorizationCode <br> <i> xs: string </i> |Authorization code of the transaction that is required to capture Maximum length: 6.
buyOrder <br> <i> xs: string </i> | Purchase order of the transaction that is required to be captured. Maximum length: 26.
commerceId <br> <i> xs: long </i> | Commercial code or mall store that carried out the transaction. Length: 12. <br> If the code you have is 8 digits you must prepend 5970.
capturedAmount <br> <i> xs: decimal </i> |Amount to be captured. Maximum length: 10.

 <strong> Capture response </strong>

java
captureResult.getToken ();
captureResult.getAuthorizationCode ();
captureResult.getAuthorizationDate ();
captureResult.getCapturedAmount ();
`` ''

`` `php
$ captureResult-> token;
$ captureResult-> authorizationCode;
$ captureResult-> authorizationDate;
$ captureResult-> capturedAmount;
`` ''

csharp
captureResult.token;
captureResult.authorizationCode;
captureResult.authorizationDate;
captureResult.capturedAmount;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Token of the transaction.
authorizationCode <br> <i> xs: string </i> | Authorization code for deferred capture.
authorizationDate <br> <i> xs: string </i> | Date and time of authorization.
capturedAmount <br> <i> xs: decimal </i> | Amount captured.

In case of error the following unique codes of the method may appear
`capture ()`:

Code | Description
------ | -----------
304 | Null input field validation
245 | Commercial code does not exist
22 | The trade is not active
316 | The indicated merchant does not correspond to the certificate or is not a child of the MALL merchant in case of MALL transactions
308 | Operation not allowed
274 | Transaction not found
16 | The transaction is not deferred capture
292 | The transaction is not authorized
284 | Capture period exceeded
310 | Transaction previously reversed
309 | Transaction previously captured
311 | Amount to capture exceeds the authorized amount
315 | Authorizer error

### Cancellation Webpay Plus

This method allows all enabled merchants to cancel a transaction that was
generated in Webpay Plus (Normal and Mall) or Oneclick Normal. The method
contemplates canceling all or part of a transaction. For this you must
indicate the data associated with the desired online sale transaction
void and the amounts required to void. A
transaction when the canceled amount or the total amount of canceled cancellations
reach the authorized amount in the online sale.

The Webpay transaction voiding web service supports a single
partial void for online sale transaction. In case of sending
a second partial override will return an `Exception`.

Executions with errors will return a SoapFault according to the
error coding defined below.

Cancellation can be made a maximum of 90 days after the date of the
original transaction.

You can [read more about the cancellation in the information of the
Webpay product] (/ product / webpay # cancellations) to know
more details and restrictions.

To cancel a transaction, the `nullify ()` method must be invoked.

 <strong> nullify () </strong>

It allows you to request from Webpay the cancellation of a transaction made previously and that is in force.

> The SDKs allow you to optionally indicate the commercial code of the
> transaction to be canceled, to support cancellation in Webpay Plus merchants
> Mall. In Webpay Plus Normal stores, it is not necessary to specify the code
> Trade as the one indicated in the configuration is used.

 <aside class="notice">
The `nullify ()` method must always be invoked indicating the code of the merchant that carried out the transaction. In the case of Webpay Plus Mall merchants, the code must be the code of the specific virtual store.
 </aside>

java
WebpayNullify transaction =
    new Webpay (configuration) .getNullifyTransaction ();

// For Webpay Plus Normal merchants
NullificationOutput result = transaction.nullify (
    authorizationCode, authorizedAmount, buyOrder, nullifyAmount);

// For Webpay Plus Mall merchants
NullificationOutput result = transaction.nullify (
    authorizationCode, authorizedAmount, buyOrder, nullifyAmount,
    storeCommerceCode);

`` ''

`` `php
$ transaction = (new Webpay (configuration)) -> getNullifyTransaction ();

// For Webpay Plus Normal merchants
$ result = transaction.nullify (
    $ authorizationCode, $ authorizedAmount, $ buyOrder, $ nullifyAmount);

// For Webpay Plus Mall merchants
$ result = transaction.nullify (
    $ authorizationCode, $ authorizedAmount, $ buyOrder, $ nullifyAmount,
    $ storeCommerceCode);

`` ''

csharp
var transaction = new Webpay (configuration) .NullifyTransaction;

// For Webpay Plus Normal merchants
var result = transaction.nullify (
    authorizationCode, authorizedAmount, buyOrder, nullifyAmount);

// For Webpay Plus Mall merchants
var result = transaction.nullify (
    authorizationCode, authorizedAmount, buyOrder, nullifyAmount,
    storeCommerceCode);
`` ''

 <strong> Nullify parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
authorizationCode <br> <i> xs: string </i> | Authorization code of the transaction that is required to be canceled. If the transaction is lazy capture, the code obtained by calling `capture ()` should be used. Maximum length: 6.
authorizedAmount <br> <i> xs: decimal </i> | Authorized amount of the transaction that is required to be canceled. If the transaction is deferred capture, the amount captured when `capture ()` was invoked should be used. Maximum length: 10.
buyOrder <br> <i> xs: string </i> | Purchase order of the transaction that is required to be canceled. Maximum length: 26.
nullifyAmount <br> <i> xs: decimal </i> | Amount to be canceled from the transaction. Maximum length: 10.
commerceId <br> <i> xs: long </i> | Commercial code or mall store that carried out the transaction. Length: 12. <br> If the code you have is 8 digits you must prepend 5970.

 <strong> nullify response </strong>

java
result.getToken ();
result.getAuthorizationCode ();
result.getAuthorizationDate ();
result.getBalance ();
result.getNullifiedAmount ();
`` ''

`` `php
$ result-> token;
$ result-> authorizationCode;
$ result-> authorizationDate;
$ result-> balance;
$ result-> nullifiedAmount;
`` ''

csharp
result.token;
result.authorizationCode;
result.authorizationDate;
result.balance;
result.nullifiedAmount;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Token of the transaction.
authorizationCode <br> <i> xs: string </i> | Cancellation authorization code.
authorizationDate <br> <i> xs: string </i> | Date and time of authorization.
balance <br> <i> xs: decimal </i> | Updated balance of the transaction (considers the sale minus the canceled amount).
nullifiedAmount <br> <i> xs: decimal </i> | Amount canceled.

In case of error, the following common error codes may appear for the `nullify ()` method:

Code | Description
------ | -----------
304 | Null input field validation
245 | Commercial code does not exist
22 | The trade is not active
316 | The indicated merchant does not correspond to the certificate or is not a child of the MALL merchant in case of MALL transactions
308 | Operation not allowed
274 | Transaction not found
16 | The transaction does not allow cancellation
292 | The transaction is not authorized
284 | Cancellation period exceeded
310 | Transaction previously voided
311 | Amount to be canceled exceeds the balance available to cancel
312 | Generic error for overrides
315 | Authorizer error
53 | The transaction does not allow partial cancellation of transactions with fees

## Oneclick Normal

 <aside class="warning">
This product is deprecated and is no longer available for purchase. Alternatively you can use Oneclick Mall REST
[click here] (https://www.transbankdevelopers.cl/referencia/webpayrest#oneclick-mall)
 </aside>

java
WebpayOneClick transaction =
    new Webpay (configuration) .getOneClickTransaction ();
`` ''

`` `php
$ transaction = (new Webpay (configuration)) -> getOneClickTransaction ();
`` ''

csharp
var transaction = new Webpay (configuration) .OneClickTransaction;

`` ''

WSDL: `/ webpayserver / wswebpay / OneClickPaymentService? Wsdl`

The Oneclick payment method allows the cardholder to make payments in the
trade without the need to enter credit card information each time
credit at the time of purchase. The payment model includes a
prior process of registration or enrollment of the cardholder, through the
trade, you want to use the service. This type of payment facilitates the sale,
decreases transaction time and reduces the risks of erroneous entry
of the data of the means of payment.

The integration process with Oneclick consists of developing by part
of the commerce the calls to the web services provided by Transbank for the
registration of cardholders, as well as for the realization of the
Payments.

### Registration and payment flow

Enrollment is the process in which the cardholder records data
of your card in Oneclick to use it in future purchases. These data are
stored securely at Transbank, and are never known to trade.
This process must be initiated by the store of the trade and it is a requirement that the
client is authenticated on the merchant page before starting the
inscription.

Process:

 <img class="td_img-night" src="/images/diagrama-secuencia-oneclick-inscripcion.png" alt="Diagrama de secuencia inscripción Oneclick">

* The client connects and authenticates on the merchant's page, through their
  username and password.
* The client selects the enrollment option, which must be explained
  on the trade page.
* The merchant consumes a web service published by Transbank, where it delivers the
  customer data and term URL; gets a token and URL from Webpay.
* The merchant sends the client's browser to the URL obtained and goes through
  parameter the token (POST method).
* Webpay presents the registration form, this is similar to the form
  current payment of Webpay Plus, for the client to enter the data of their
  card.
* The customer will be authenticated by their issuing bank, similar to the flow
  normal payment. At this point a transaction of $ 1 peso is made, which
  it is not captured (it will not be reflected in your account statement).
* After the registration, Webpay sends the client's browser to the URL
  delivered by the merchant, passing the token as a parameter.
* The merchant must consume another Transbank web service, with the token, to
  get the result of the enrollment and the user identifier, which
  must be used in the future to make payments.
* The merchant presents the result of the registration to the customer.

After the registration process is complete, the merchant can initiate the payment process when appropriate.

Payment is the process where the merchant requests the charge of a purchase to the
credit card of a previously registered user, using the
identifier provided by Transbank at the time of registration.

Payments in this mode do not necessarily require the intervention of the
Username.

The amount of the payment must be within the limits established for this type
of transactions, the internal process is similar to a normal Webpay charge.
Process:

 <img class="td_img-night" src="/images/diagrama-secuencia-oneclick-pago.png" alt="Diagrama de secuencia inscripción Oneclick">

* The client connects and authenticates on the merchant's page or application
  using your username and password.
* The customer selects the option to pay with Oneclick.
* The merchant uses the payment web service, published by Transbank, delivering
  the user identifier (obtained at registration), the amount of the
  payment and purchase order. Get the response with the code of
  authorization.
* The merchant presents the result of the payment to the customer.

### Create a Oneclick registration

To perform the first of the processes described (enrollment), the `initInscription ()` method must be called

 <strong> initInscription () </strong>

Allows you to register the cardholder and information about your
credit card. Returns a token that represents the
enrollment transaction and a URL (`urlWebpay`), which corresponds to the URL
Oneclick enrollment.

Once this web service is called, the user must be redirected
via POST to `urlWebpay` with parameter` TBK_TOKEN` equal to the token obtained.

 <aside class="notice">
Note that unlike Webpay Plus, where the parameter is called `token_ws`, in
Oneclick the parameter is called `TBK_TOKEN`.
 </aside>

java
OneClickInscriptionOutput initResult =
    transaction.initInscription (username, email, urlReturn);
`` ''

`` `php
$ initResult =
    transaction-> initInscription (username, email, urlReturn);

`` ''

csharp
var initResult =
    transaction.initInscription (username, email, urlReturn);
`` ''

 <strong> initInscription parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
username <br> <i> xs: string </i> | User identifier registered in the store. Maximum length: 256.
email <br> <i> xs: string </i> | Email of the user registered in the store. Maximum length: 256.
responseURL <br> <i> xs: string </i> | URL of the merchant to which Webpay will redirect after the registration process. Maximum length: 256.

 <strong> initInscription response </strong>

java
initResult.getToken ();
initResult.getUrlWebpay ();
`` ''

`` `php
$ initResult-> token;
$ initResult-> urlWebpay;
`` ''

csharp
initResult.token;
initResult.urlWebpay;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Registration token.
urlWebpay <br> <i> xs: string </i> | Webpay form URL.

 <aside class="notice">
Once this webservice is called, the user must be redirected via
POST to `urlWebpay` with parameter` TBK_TOKEN` equal to the token.
 </aside>

### Confirm a registration Oneclick

Once the registration flow in Transbank is finished, the user is sent to
The end of enrollment URL that defined the merchant. At that moment the
trade must call `finishInscription ()`.

 <strong> finishInscription () </strong>

It allows to finish the cardholder registration process in Oneclick.
Returns the identifier of the user in Oneclick, which will be used to
carry out payment transactions.

java
OneClickFinishInscriptionOutput result =
    transaction.finishInscription (
        request.getParameter ("TBK_TOKEN"));
`` ''

`` `php
$ result = $ transaction-> finishInscription (
    $ request-> input ("TBK_TOKEN"));
`` ''

csharp
var result = transaction.finishInscription (tbkToken);
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Registration token.

 <strong> finishInscription response </strong>

java
result.getResponseCode ();
result.getAuthCode ();
result.getCreditCardType (). getValue ();
result.getLast4CardDigits ();
result.getTbkUser ();
`` ''

`` `php
$ result-> responseCode;
$ result-> authCode;
$ result-> creditCardType;
$ result-> last4CardDigits;
$ result-> tbkUser;
`` ''

csharp
result.responseCode;
result.authCode;
result.creditCardType;
result.last4CardDigits;
result.tbkUser;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
responseCode <br> <i> xs: int </i> | Return code from the enrollment process, where 0 (zero) is approved.
authCode <br> <i> xs: string </i> | Code that identifies the authorization of the registration.
creditCardType <br> <i> creditCardType </i> | Indicates the type of card registered by the customer (Visa, AmericanExpress, MasterCard, Diners, Magna).
last4CardDigits <br> <i> xs: string </i> | The last 4 digits of the card entered by the client in the registration.
tbkUser <br> <i> xs: string </i> | Unique identifier of the customer's registration in Oneclick, which must be used to make payments or delete the registration.

### Authorize a payment with Oneclick

After registration, the merchant can use the received `tbkUser`
to carry out transactions. For that you must use the `authorize ()` method.

#### authorize ()

Allows payment transactions. Returns the result of the
authorization. This method must be executed every time the user
select pay with Oneclick at the merchant.

java
OneClickPayOutput output = transaction.authorize (
    buyOrder, tbkUser, username, amount);
`` ''

`` `php
$ output = $ transaction.authorize (
    buyOrder, tbkUser, username, amount);
`` ''

csharp
var output = transaction.authorize (
    buyOrder, tbkUser, username, amount);

`` ''

 <strong> Authorize parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
amount <br> <i> xs: decimal </i> | Amount of payment in pesos.
buyOrder <br> <i> xs: long </i> | Unique identifier of the purchase generated by the merchant.
tbkUser <br> <i> xs: string </i> | Unique identifier of the customer's enrollment (returned by `finishInscription ()`).
username <br> <i> xs: string </i> | User identifier in the merchant's systems (the same one indicated in `initInscription ()`).

 <strong> Reply authorize </strong>

java
output.getAuthorizationCode ();
output.getCreditCardType (). value ();
output.getLast4CardDigits ();
output.getTransactionId ();
output.getResponseCode ();
`` ''

`` `php
$ output-> authorizationCode;
$ output-> creditCardType;
$ output-> last4CardDigits;
$ output-> transactionId;
$ output-> responseCode;
`` ''

csharp
output.authorizationCode;
output.creditCardType;
output.last4CardDigits;
output.transactionId;
output.responseCode;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
authorizationCode <br> <i> xs: string </i> | Authorization code of the payment transaction.
creditCardType <br> <i> creditCardType </i> | Indicates the type of card that was registered by the customer (Visa, AmericanExpress, MasterCard, Diners, Magna).
last4CardDigits <br> <i> xs: string </i> | The last 4 digits of the card used in the transaction.
transactionId <br> <i> xs: long </i> | Unique identifier of the payment transaction.
responseCode <br> <i> xs: int </i> | Return code of the payment process, where: <br> 0 (zero) is approved. <br> -1, -2, -3, -4, -5, -6, -7, -8: Rejection <br> -96: There is no associated registration. <br> -97: Oneclick limits, maximum daily payment amount exceeded. <br> -98: Oneclick limits, maximum payment amount exceeded <br> -99: Oneclick limits, maximum amount of daily payments exceeded.

### Reverse a Oneclick payment

This process allows a sale to be reversed when it could not be completed, within the same accounting day, in order to cancel a charge made to the customer. For this, the `codeReverseOneClick ()` method must be consumed with the purchase order of the transaction to be reversed.

 <strong> codeReverseOneClick () </strong>

Allows you to reverse a previously authorized sale transaction. East
method returns as response a unique identifier of the transaction
reverse.

java
boolean success = transaction.reverseTransaction (buyOrder);
`` ''

`` `php
$ result = $ transaction-> reverseTransaction ($ buyOrder);
`` ''

csharp
var result = transaction.reverseTransaction (buyOrderLong);
`` ''

 <strong> Parameters codeReverseOneClick </strong>

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: long </i> | Purchase order of the transaction to be reversed.

 <strong> Answer codeReverseOneClick </strong>

java
// The Java SDK only returns the status boolean, not the reverse code :(
success;
`` ''

`` `php
// The PHP SDK only returns the status boolean, not the reverse code :(
$ result-> success;
`` ''

csharp
result.reversed;
result.reverseCode;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
reversed <br> <i> xs: boolean </i> | Indicates whether the reversal was successful.
reverseCode <br> <i> xs: long </i> | Unique identifier of the reverse transaction.

### Cancel a Oneclick payment

In the event that it is no longer the same accounting day and it is required to cancel a
sale, it is possible to cancel a payment made with Oneclick Normal using [the
same method of cancellation Webpay Plus] (# cancellation-webpay-plus).

### Delete a Oneclick registration

In the event that the business requires deleting the registration of a user in
Oneclick either by deleting a client on your system or by the
request for this to not operate with this form of payment, the merchant must
invoke `removeUser ()` with the user identifier given in the
inscription.

 <strong> removeUser () </strong>

Allows you to delete a user registration in Transbank

java
boolean success = transaction.removeUser (tbkUser, username);
`` ''

`` `php
$ success = $ transaction-> removeUser ($ tbkUser, $ username);
`` ''

csharp
var success = transaction.RemoveUser (tbkUser, username);
`` ''

 <strong> RemoveUser parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
tbkUser <br> <i> xs: string </i> |Unique identifier of customer enrollment
username <br> <i> xs: string </i> | User identifier in the merchant's systems (the same one indicated in `initInscription ()`).

 <strong> RemoveUser response </strong>

The response boolean will be `true` on success and` false` otherwise.

## Oneclick Mall

 <aside class="warning">
This product is deprecated and is no longer available for purchase. Alternatively you can use Oneclick Mall REST
[click here] (https://www.transbankdevelopers.cl/referencia/webpayrest#oneclick-mall)
 </aside>

> SDKs do not support Oneclick Mall services yet.

WSDL: `/ WSWebpayTransaction / cxf / WSOneClickMulticodeService? Wsdl`

### Registration and payment flow Mall

The flow of Oneclick Mall is generally the same as that of [Webpay
Oneclick Normal] (# webpay-oneclick-normal) both for the cardholder and
facing the integrator.

The difference are:

* The user must be registered on the page of the business "mall" grouping,
  but the transactions are in the name of the "stores" of the mall.
* You can indicate multiple transactions to authorize in the same operation.
* The result of each of these transactions must be verified separately
  individually, as the card issuer may authorize some
  and others not.

### Create a Oneclick Mall registration

To start the enrollment, use the `initInscription ()` method

 <strong> initInscription () Mall </strong>

It allows to trigger the start of the registration process.

> SDKs do not support Oneclick Mall services yet.

 <strong> initInscription Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
username <br> <i> xs: string </i> | User identifier registered in the store.
email <br> <i> xs: string </i> | Email of the user registered in the store.
returnUrl <br> <i> xs: string </i> | URL to which the client will be sent after the registration process.

 <strong> initInscription Mall response </strong>

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Unique identifier of the registration process. It must be sent by parameter (`TBK_TOKEN`) to the URL` urlInscriptionForm`.
urlInscriptionForm <br> <i> xs: string </i> | Webpay URL to start enrollment.

 <aside class="notice">
Once this webservice is called, the user must be redirected via
POST to `urlInscriptionForm` with parameter` TBK_TOKEN` equal to token.
 </aside>

### Confirm an enrollment Oneclick Mall

Once the registration flow in Transbank is finished, the user is sent to
the end of enrollment URL that was defined by the merchant (`returnUrl`). In that
instantly the trade should call `finishInscription ()`.

 <aside class="warning">
The trade will have a maximum of 60 seconds to call this method afterwards
to receive the token at the end of enrollment URL (`returnUrl`). Past the
60 seconds without call to finishInscription, enrollment in progress along with
the user will be deleted.
 </aside>

 <strong> finishInscription () Mall </strong>

It allows to finish the registration process by obtaining the user tbk.

> SDKs do not support Oneclick Mall services yet.

 <strong> finishInscription Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Enrollment process identifier. It is delivered by Webpay in the response of the `initInscription ()` method.

 <strong> finishInscription Mall response </strong>

Name <br> <i> type </i> | Description
------   | -----------
responseCode <br> <i> xs: int </i> | Enrollment process response code, where 0 (zero) is approved.
authorizationCode <br> <i> xs: string </i> | Code that identifies the authorization of the registration.
creditCardType <br> <i> creditCardType </i> | Indicates the brand of the credit card that was registered by the customer (Visa, AmericanExpress, MasterCard, Diners, Magna)
cardNumber <br> <i> xs: string </i> | Indicates the last 4 digits and / or BIN of the credit card used.
cardExpirationDate <br> <i> xs: string </i> | Indicates the expiration date of the credit card used.
cardOrigin <br> <i> cardOrigin </i> | Indicates whether the credit card used is national (NATIONAL_CARD) or foreign (FOREIGN_CARD).
tbkUser <br> <i> xs: string </i> | Unique identifier of the customer's registration, this must be used to make payments or delete the registration.

### Authorize a payment with Oneclick Mall

After registration, the merchant can use the received `tbkUser`
to carry out transactions. For that you must use the `authorize ()` method.

 <strong> authorize () Mall </strong>

Allows you to authorize a payment.

> SDKs do not support Oneclick Mall services yet.

 <strong> Authorize Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: long </i> | Unique identifier of the operation for the mall trade.
tbkUser <br> <i> xs: string </i> | Unique identifier of the customer's enrollment (returned by `finishInscription ()`).
username <br> <i> xs: string </i> | User identifier in the merchant's systems (the same one indicated in `initInscription ()`).
storesInput <br> <i> wsOneClickMulticodeStorePaymentInput </i> | List of objects with the information of each transaction of the stores in the mall.
storesInput []. commerceId <br> <i> xs: long </i> | Trade code child of the store.
storesInput []. buyOrder <br> <i> xs: string </i> | Unique identifier of the purchase generated by the child business (store).
storesInput []. amount <br> <i> xs: decimal </i> |Amount of the payment sub-transaction. In pesos or dollars depending on the configuration of the parent mall trade.
storesInput []. sharesNumber <br> <i> xs: int </i> | Amount of installments of the payment sub-transaction.

 <aside class="warning">
Any non-number value in `sharesNumber` (including letters,
non-existence of the field or null) will be assumed as zero, that is, "No quotas".
 </aside>

 <strong> Authorize Mall Response </strong>

Name <br> <i> type </i> | Description
------   | -----------
commerceId <br> <i> xs: long </i> | Commercial code of the parent company.
buyOrder <br> <i> xs: string </i> | Purchase order generated by the parent business.
settlementDate <br> <i> xs: string </i> | Accounting date of payment authorization.
authorizationDate <br> <i> xs: dateTime </i> | Full date (timestamp) of the payment authorization.
storesOutput <br> <i> wsOneClickMulticodeStorePaymentOutput </i> | List with the result of each transaction of the child stores.
storesOutput []. commerceId <br> <i> xs: long </i> | Commercial code of the child trade (store).
storesOutput []. buyOrder <br> <i> xs: string </i> | Purchase order generated by the child merchant for the payment sub-transaction.
storesOutput []. amount <br> <i> xs: decimal </i> | Amount of the payment sub-transaction.
storesOutput []. authorizationCode <br> <i> xs: string </i> | Authorization code of the payment sub-transaction.
storesOutput []. paymentType <br> <i> xs: string </i> | [Type] (/ product / webpay # payment-types) (VC, NC, SI, etc.) of the payment sub-transaction.
storesOutput []. responseCode <br> <i> xs: int </i> | Return code of the payment process, where: <br> 0 (zero) is approved. <br> -1, -2, -3, -4, -5, -6, -7, -8: Rejection <br> -97: Oneclick limits, maximum daily payment amount exceeded. <br> -98: Oneclick limits, maximum payment amount exceeded <br> -99: Oneclick limits, maximum amount of daily payments exceeded.
storesOutput []. sharesNumber <br> <i> xs: int </i> | Amount of installments of the payment sub-transaction.
storesOutput []. shareAmount <br> <i> xs: decimal </i> | Amount per installment of the payment sub-transaction.

### Reverse or Cancel a payment Oneclick Mall

For Oneclick Mall there are two different operations to void
Authorized transactions: Reversal and cancellation.

** The reverse ** applies to ** operational problems (trade side) or
communication between commerce and Transbank that prevent receiving the
response of an authorization **. In such a case the trade ** must ** try
reverse the authorization transaction to avoid a possible mismatch between
commerce and Transbank. The reverse works on the complete operation of the mall,
which means that ** all transactions carried out in the mall operation
will be reversed **. And it can only be used up to 30 seconds after
call to `authorize ()`

** The cancellation **, on the other hand, acts individually on the transactions of
the _tiendas_ of a mall. Hence, ** override is the correct operation to
use for financial purposes **, in order to cancel a charge already made.
It is also possible * to reverse an override * due to operational issues
(for example a communication error at the time of canceling, which prevents the
commerce to know if Transbank received the annulment).

To carry out the reverse, the trade must use the `reverse ()` method. For override, the `nullify ()` method should be used. And to reverse an override there is the `reverseNullification ()` method

 <strong> reverse () Mall </strong>

Allows you to reverse an authorization operation.

> SDKs do not support Oneclick Mall services yet.

 <strong> Reverse Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: string </i> | Purchase order generated by the parent merchant (mall) for the operation to be reversed.

 <strong> Reverse Mall response </strong>

The answer is a list with as many elements as there are transactions the
operation identified by `buyOrder`:

Name <br> <i> type </i> | Description
------   | -----------
[] .commerceId <br> <i> xs: long </i> | Commercial code of the child trade (store).
[] .buyOrder <br> <i> xs: string </i> | Purchase order of the child business for the payment sub-transaction.
[] .reversed <br> <i> xs: boolean </i> | Indicates whether the reverse was successful or not.
[] .reverseCode <br> <i> xs: string </i> | Unique identifier of the reverse transaction.

 <strong> nullify () Mall </strong>

Allows you to cancel a payment.

> SDKs do not support Oneclick Mall services yet.

 <strong> Nullify Mall parameters </strong>

Name | Description
------ | -----------
commerceId | Identifier of the child merchant (store) for the payment sub-transaction to be canceled.
buyOrder  | Purchase order generated by the child merchant, for the payment sub-transaction to be canceled.
authorizedAmount | Amount of the payment sub-transaction to be canceled.
authorizationCode | Authorization code of the payment sub-transaction to be canceled.
nullifyAmount | Amount to be canceled from the payment sub-transaction. It can be a partial amount or a full amount.

 <strong> Nullify Mall response </strong>

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> | Unique identifier of the reversal transaction.
buyOrder <br> <i> xs: string </i> | Purchase order of the canceled payment sub-transaction.
commerceId <br> <i> xs: long </i> | Commercial code of the child trade (store).
authorizationCode <br> <i> xs: string </i> | Cancellation transaction authorization code.
authorizationDate <br> <i> xs: dateTime </i> | Cancellation transaction authorization date.
nullifiedAmount <br> <i> xs: decimal </i> | Amount canceled.
balance <br> <i> xs: decimal </i> | Remaining amount of original payment sub-transaction: initial amount - voided amount.

 <strong> reverseNullification () </strong>

Allows you to reverse an override.

> SDKs do not support Oneclick Mall services yet.

 <strong> reverseNullification parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: string </i> | Purchase order generated by the child merchant, for the canceled payment sub-transaction.
commerceId <br> <i> xs: long </i> | Commercial code of the child trade (store).
nullifyAmount <br> <i> xs: decimal </i> | Amount reversed in the reversal transaction that is being reversed.

 <strong> reverseNullification response </strong>

Name <br> <i> type </i> | Description
------   | -----------
reversed <br> <i> xs: boolean </i> | Indicates whether the reverse was successful or not.
reverseCode <br> <i> xs: long </i> | Unique identifier of the reverse transaction.

 <aside class="warning">
The call to this method and thus the reverse operation of abort,
It will only be valid within 30 seconds after the call of the
method `nullify ()`.
 </aside>

### Delete an enrollment Oneclick Mall

In the event that the merchant requires to remove the registration of a user in Oneclick Mall, either by removing a customer from its system or by requesting the latter not to operate with this form of payment, the merchant must invoke `removeInscription ( ) `with the user identifier given in the registration.

 <strong> removeInscription () Mall </strong>

Allows you to delete a user registration in Oneclick Mall

> SDKs do not support Oneclick Mall services yet.

 <strong> removeInscription Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
tbkUser <br> <i> xs: string </i> | Unique identifier of the customer's enrollment.
username <br> <i> xs: string </i> | User name, of the client, in the merchant's system.

 <strong> RemoveInscription Mall response </strong>

Name <br> <i> type </i> | Description
------   | -----------
result <br> <i> xs: boolean </i> | Indicates whether the deletion was successful or not.

### Deferred Capture Oneclick Mall

> SDKs do not support Oneclick Mall services yet.

A Oneclick Mall transaction allows the cardholder to record their
card in the same way as occurs with a Oneclick transaction, associating
said registration to a parent business. Now, once the registration is done,
the parent merchant is allowed to authorize transactions without capture for
registered “child” businesses that have delayed capture enabled.
In addition, after authorization, you are allowed to capture said reserved amount.
The authorization is responsible for validating whether it is possible to charge the
account associated with the credit card making the reservation in the same act
of transaction amount.
The capture makes effective the reservation made previously or charge in the account of
credit associated with the cardholder's card.
These modalities, separately, are only valid for credit cards.

To make this explicit capture, the `capture ()` method must be used

 <strong> capture () Mall </strong>

This method allows Oneclick Mall enabled merchants to be able to
perform deferred captures of a previously authorized transaction. The method
it contemplates a single catch for each authorization. To do this, you must indicate the
data associated with the sale transaction and the amount required to capture, which
It must be less than or equal to the originally authorized amount.
To capture a transaction, it must have been created by a code of
trade configured for deferred capture. In this way the transaction will be
authorized but will require a later explicit capture to confirm the
transaction.

 <strong> Capture Mall parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
authorizationCode <br> <i> xs: string </i> | Authorization code of the transaction that is required to be captured. Maximum length: 6.
buyOrder <br> <i> xs: string </i> | Purchase order of the transaction that is required to be captured. Maximum length: 26.
commerceId <br> <i> xs: long </i> | Mall store code that carried out the transaction. Length: 12. <br> If the code you have is 8 digits you must prepend 5970.
capturedAmount <br> <i> xs: decimal </i> | Amount to be captured. Maximum length: 10.

 <aside class="notice">
The `capture ()` method must be invoked always indicating the code of the
specific virtual store trade.
 </aside>

 <strong> Capture Mall response </strong>

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> | Token of the transaction.
authorizationCode <br> <i> xs: string </i> | Authorization code for deferred capture.
authorizationDate <br> <i> xs: string </i> | Date and time of authorization.
capturedAmount <br> <i> xs: decimal </i> | Amount captured.

 <aside class="notice">
In case of error, the same exclusive codes of the `capture ()` method will appear.
for simultaneous capture.
 </aside>
