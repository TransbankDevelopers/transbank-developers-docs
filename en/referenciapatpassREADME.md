# PatPass

## Environments and Credentials

### Production environment

java
Configuration configuration = new Configuration ();
configuration.setEnvironment (Webpay.Environment.LIVE);
`` ''

`` `php
EARRING
`` ''

csharp
var configuration = new Configuration ();
configuration.Environment = "PRODUCTION";
`` ''

Production endpoint URLs are hosted within
 <https://webpay3g.transbank.cl/.>

> The SDKs come pre-configured with Transbank certificates and validate
> automatically the answers. You just have to make sure you keep your SDK
> updated to prevent preconfigured certificates from expiring.
> Or you can also manually overwrite the Webpay certificate to use
> for validation:

java
configuration.setWebpayCert (
    "----- BEGIN CERTIFICATE ----- \ n" +
    "MIIEDzCCAvegAwIBAgIJAMaH4DFTKdnJMA0GCSqGSIb3DQEBCwUAMIGdMQswCQYD \ n" +
    "VQQGEwJDTDERMA8GA1UECAwIU2FudGlhZ28xETAPBgNVBAcMCFNhbnRpYWdvMRcw \ n" +
    ...
    "MX5lzVXafBH / sPd545fBH2J3xAY3jtP764G4M8JayOFzGB0 = \ n" +
    "----- END CERTIFICATE ----- \ n");
`` ''

`` `php
EARRING
`` ''

csharp
configuration.WebpayCertPath = @ "C: \ Certs \ public-certificate-transbank.crt"
`` ''

To validate the responses generated by Transbank you must use a public Webpay certificate. In [the GitHub repository
`transbank-webpay-credenciales`] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/)
you can find [the certificate
updated] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/tree/master/produccion).

### Integration Environment

java
configuration.setEnvironment (Webpay.Environment.TEST);
`` ''

`` `php
EARRING
`` ''

csharp
configuration.Environment = "INTEGRATION";
`` ''

Integration endpoint URLs are hosted within
 <https://webpay3gint.transbank.cl/>.

See [documentation for test cards that work on
the integration environment] (/ documentation / how to start # environments).

### Trade Credentials

java
configuration.setCommerceCode ("597044444432");
configuration.setPrivateKey (
    "----- BEGIN RSA PRIVATE KEY ----- \ n" +
    ... +
    "----- END RSA PRIVATE KEY ----- \ n"
);
configuration.setPublicCert (
    "----- BEGIN CERTIFICATE ----- \ n" +
    ... +
    "----- END CERTIFICATE ----- \ n"
);
`` ''

`` `php
EARRING
`` ''

csharp
configuration.CommerceCode = "597044444432";
configuration.PrivateCertPfxPath = @ "C: /Path/to/private/Cert.pfx";
configuration.Password = "PfxPassword";
`` ''

All requests you make must be signed with your private key and
certificate sent to Transbank. These credentials must match the
commercial code used in each request.

 <aside class="notice">
Please note that your trade code (s) in production environment are not
equal to those delivered for the integration environment.
 </aside>

 <aside class="warning">
Unlike other SDKs, in .NET you must specify the path to a pfx or p12 file
which you must generate from your private key and public certificate.

You can look at the following link for a quick guide on how to generate your own file: [Create pfx file using openssl] (https://www.ssl.com/how-to/create-a-pfx-p12-certificate-file -using-openssl /)
 </aside>

See [the documentation to generate a private key and a certificate
using openssl] (/ documentation / how to start # credentials-in-webpay if you don't know how to do it yet.

In [the GitHub repository
`transbank-webpay-credenciales`] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/)
you will be able to find [updated merchant codes and certificates to test
in integration even if you don't have your own code yet
commerce] (https://github.com/TransbankDevelopers/transbank-webpay-credenciales/tree/master/integracion).

> The SDKs already include these commercial codes, certificates and private keys
which work in the integration environment, so you can get
> quickly a configuration ready to do your first tests in said
> environment:

java
Configuration configuration =
    Configuration.forTestingPatPassByWebpayNormal ("test@mail.co");
`` ''

`` `php
EARRING
`` ''

csharp
var configuration = Configuration.ForTestingPatPassByWebpayNormal ("test@mail.co");
`` ''

## PatPass by Webpay Normal

java
PatPassByWebpayNormal transaction =
    new Webpay (configuration) .getPatPassByWebpayTransaction ();
`` ''

`` `php
EARRING
`` ''

csharp
var transaction = new Webpay (configuration) .PatPassByWebpayTransaction;
`` ''

WSDL: `/ WSWebpayTransaction / cxf / WSWebpayService? Wsdl`

A PatPass by WebPay authorization transaction corresponds to an enrollment request for a recurring credit card payment, where the first payment is resolved instantly, and subsequent payments are scheduled to be executed month by month. PatPass by WebPay has an expiration or expiration date, which must be provided along with other information for this transaction. The transaction can be carried out in pesos and it is possible to send the amount in UF. WebPay will convert to pesos at the time of charging the cardholder.

The payment flow in PatPass by WebPay starts from the merchant, where the Cardholder selects the product or service. Once this is done, choose to pay with PatPass by WebPay, where the payment form is displayed and the required data is completed, giving way to the Cardholder authentication process in order to validate that the card is being used by the holder. Once the authentication is resolved, the payment is authorized and if it is approved, an electronic payment receipt is issued and the system proceeds to generate the inscription in charge of the monthly recurrence.

Among the most relevant attributes of WebPay we can mention:

* Allows secure and online transactions over the Internet.
* In transactions with WebPay Plus, the cardholder is requested to authenticate with their issuer, thus protecting the merchant from possible fraud or unknown purchases.
* Security is reinforced through the use of secure servers, protected with TLS 1.2
* Digital signature.

### Flow in case of success

For the cardholder, the page flow for the transaction is as follows:

! [PatPass by Webpay Normal page flow] (/ images / page-flow-webpay.png)

From a technical point of view, the sequence is as follows:

! [PatPass by Webpay Normal sequence diagram] (/ images / webpay-sequence-diagram.png)

1. Once the goods or services have been selected, the cardholder decides to pay through PatPass by WebPay.
2. The merchant initiates a transaction in Webpay, invoking the `initTransaction ()` method.
3. Webpay processes the request and delivers, as a result of the operation, the transaction token and redirection URL to which the cardholder must be redirected.
4. Commerce redirects the cardholder to Webpay, with the transaction token to the URL indicated in point 3. The redirection is carried out by sending the token in variable `token_ws` by POST method.
5. The cardholder's Web browser makes an HTTPS request to Webpay, based on the redirection generated by the merchant in point 4.
6. Webpay responds to the request by displaying the Webpay payment form. From this point the communication is between Webpay and the cardholder, without interfering with the trade. The PatPass by Webpay payment form displays, among other things, the transaction amount, subscription termination date, merchant information such as name and logo, and the option to pay through credit.
7. Cardholder enters card details, clicks pay.
8. WebPay processes the authorization request (first bank authentication and then the authorization of the transaction), and if everything is successful, it goes through the registration process of PatPass by WebPay.
9. Once the authorization is resolved, WebPay returns control to the merchant, performing an HTTPS redirection to the merchant's transition page, where the transaction token is sent by POST method in the `token_ ws` variable. The merchant must implement the reception of this variable.
10. The cardholder's Web browser makes an HTTPS request to the merchant's site, based on the redirection generated by WebPay in point 9.
11. The merchant site receives the `token_ws` variable and invokes the second web method,` getTransactionResult () `(while the transition page is displaying), to get the authorization result. It is recommended that the authorization result be persisted in the merchant systems, since this method can be invoked only once per transaction.
12. Commerce receives the result of the invocation of the `getTransactionResult ()` method.
13. In order for the merchant to inform WebPay that the result of the transaction has been received without problems, the merchant's system must consume the third method `acknowledgeTrasaction ()`. If this was executed correctly the product can be released to the customer.

    >    Los SDKs consumen `acknowledgeTransaction()` de manera automática, tan pronto
    >    reciben una respuesta de `getTransactionResult()`.

    <aside class="warning">
      De no ser consumido `acknowledgeTransaction()` o demorar más de 30 segundos en
      su consumo, Webpay realizará la reversa de la transacción, asumiendo que
      existieron problemas de comunicación. En este caso el método retorna una
      Excepción indicando la situación. Esta excepción debe ser manejada para no
      entregar el producto o servicio en caso que ocurra.
    </aside>

14. Once the result of the transaction has been received and WebPay is informed of its correct reception, the merchant's site must redirect the cardholder back to WebPay, in order to display the payment receipt. It is important to make this point so that the cardholder understands that the payment process was successful, and that it will involve a charge to their bank card. The redirection to WebPay is done using as destination the URL provided by the `getTransactionResult ()` method, sending the transaction token in the `token_ws` variable by POST method.
15. WebPay receives a request with the token in the variable `token_ws`.
16. WebPay identifies the transaction and displays the proof of payment to the cardholder.
17. Once the payment receipt is displayed for a limited period of time, the cardholder is redirected back to the merchant's site, through redirection with the token in the `token_ws` variable sent by POST method to the final page reported by the merchant in the `initTransaction ()` method.
18. Commerce site displays final payment page.

### Flow if user aborts payment

! [Sequence diagram if user aborts
payment] (/ images / diagram-sequence-webpay-abort.png)

If the cardholder cancels the transaction in the Webpay payment form, the flow changes and the steps are as follows:

1. Once the goods or services have been selected, the cardholder decides to pay through PatPass by WebPay.
2. The merchant initiates a transaction in Webpay, invoking the `initTransaction ()` method.
3. Webpay processes the request and delivers, as a result of the operation, the transaction token and redirection URL to which the cardholder must be redirected.
4. Commerce redirects the cardholder to Webpay, with the transaction token to the URL indicated in point 3. The redirection is carried out by sending the token in variable `token_ws` by POST method.
5. The cardholder's Web browser makes an HTTPS request to Webpay, based on the redirection generated by the merchant in point 4.
6. Webpay responds to the request by displaying the Webpay payment form. From this point the communication is between Webpay and the cardholder, without interfering with the trade. The PatPass by Webpay payment form displays, among other things, the transaction amount, subscription termination date, merchant information such as name and logo, and the option to pay through credit.
7. Cardholder clicks void in PatPass by WebPay form.
8. Webpay returns control to the merchant, performing an HTTPS redirection towards the ** end of the merchant ** page, where the transaction token is sent by POST method in the variable `TBK_TOKEN` in addition to the variables` TBK_ORDEN_COMPRA` and ` TBK_ID_SESION`.

    <aside class="warning">
        Nota que el nombre de las variables recibidas es diferente. En lugar de `token_ws` acá el token viene en la variable `TBK_TOKEN`.
    </aside>

9. Trading with the variable `TBK_TOKEN` should invoke the method
   `getTransactionResult ()`, to obtain the authorization result. In
   this case should get an exception, as the payment was aborted.
10. The merchant must inform the cardholder that their payment was not completed.

### Create a PatPass by Webpay Normal transaction

To create a transaction, just call the `initTransaction ()` method

 <strong> initTransaction () </strong>

It allows to initialize a transaction in Webpay. In response to the invocation, a toke is generated that uniquely represents a transaction.

 <aside class="notice">
It is important to consider that once this method is invoked, the token that is delivered has a reduced life span of 5 minutes, after which the token is expired and cannot be used in a payment.
 </aside>

java
WsInitTransactionOutput initResult = transaction.initTransaction (
        amount, sessionId, buyOrder, returnUrl, finalUrl, patPassInfo);
`` ''

`` `php
EARRING
`` ''

csharp
wsInitTransactionOutput initResult = transaction.initTransaction (
    amount, buyOrder, sessionId, returnUrl, finalUrl, patPassInfo);
`` ''

 <strong> Parameters </strong>

Name <br> <i> type </i> | Description
------ | -----------
WSTransactionType <br> <i> wsTransactionType </i> | Indicates the type of transaction, its value must always be TR_NORMAL_WS_WPM. SDKs automatically take care of this parameter
sessionId <br> <i> xs: string </i> | (Optional) Session identifier, internal trade use, this value is returned at the end of the transaction. Maximum length: 61
returnURL <br> <i> xs: anyURI </i> | URL of the merchant, to which Webpay will redirect after the authorization process. Maximum length: 256
finalURL <br> <i> xs: anyURI </i> | URL of the merchant to which Webpay will redirect after the successful Webpay voucher. Maximum length 256
transactionDetails <br> <i> wsTransactionDetail </i> | List of objects of type wsTransactionDetail, which contains transaction data. For this type of transaction it must contain exactly one element
transactionDetails [0] .amount <br> <i> xs: decimal </i> | Amount of the transaction. Maximum 2 decimal places for USD and UF. Maximum length: 10
transactionDetails [0] .buyOrder <br> <i> xs: string </i> | Store purchase order. This number must be unique for each transaction. Maximum length: 26. The purchase order can have: Numbers, letters, upper and lower case, and the signs <code> & # 124; _ = &%., ~: /? [+! @ ()> - </code>
transactionDetails [0] .commerceCode <br> <i> xs: string </i> | Commercial code of the store delivered by Transbank. Long: 12. The SDKs automatically take care of this parameter from the merchant configuration and certificates / keys used to initiate the transaction
wPMDetail <br> <i> wpmDetailInput </i> | Object of type wpmDetailInput, which contains data associated with the PatPass by WebPay enrollment. The SDKs take care of these parameters by passing them inside a PatPassInfo object in the `initTransacction ()` function.
wPMDetail.serviceId <br> <i> xs: string </i> | Corresponds to the service identifier with which the merchant identifies its customer. Maximum length: 30
wPMDetail.cardHolderId <br> <i> xs: string </i> | RUT of the cardholder. Maximum length: 12. Format: NNNNNNNNA
wPMDetail.cardHolderName <br> <i> xs: string </i> | Cardholder name. Maximum length: 50
wPMDetail.cardHolderLastName1 <br> <i> xs: string </i> | Cardholder paternal last name. Maximum length: 50
wPMDetail.cardHolderLastName2 <br> <i> xs: string </i> | Cardholder maternal last name. Maximum length: 50
wPMDetail.cardHolderMail <br> <i> xs: string </i> | Cardholder email. Maximum length: 50
wPMDetail.cellPhoneNumber <br> <i> xs: string </i> | Cardholder cell phone number. Maximum length: 12
wPMDetail.expirationDate <br> <i> xs: dateTime </i> | PatPass by WebPay expiration date, corresponds to the last payment. Length: 10. Format YYYY-MM-DD
wPMDetail.commerceMail <br> <i> xs: string </i> | E-mail commerce. Maximum length: 50. The SDKs automatically take care of this parameter from the merchant email entered in the configuration used to initiate the transaction
wPMDetail.ufFlag <br> <i> xs: boolean </i> | Value in true indicates that the amount sent is expressed in UF, value in false indicates that value is expressed in pesos. The SDKs automatically take care of this parameter from the configuration of currency and certificates / keys used to initiate the transaction

 <strong> Answer </strong>

java
initResult.getUrl ();
initResult.getToken ();
`` ''

`` `php
EARRING
`` ''

csharp
initResult.url;
initResult.token;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
token <br> <i> xs: string </i> |Token of the transaction. Length: 64.
url <br> <i> xs: string </i> | PatPass by Webpay payment form URL. Maximum length: 256.

### Confirm a PatPass by Webpay Normal transaction

When the merchant takes back control using `returnURL` you can commit a transaction using the` getTransactionResult () `and` acknowledgeTransaction () `methods

 <strong> getTransactionResult () </strong>

It allows you to obtain the result of the transaction once Webpay has resolved your financial authorization.

java
TransactionResultOutput result =
    transaction.getTransactionResult (
        request.getParameter ("token_ws"));
`` ''

`` `php
EARRING
`` ''

csharp
transactionResultOutput result =
    transaction.getTransactionResult (Request.Form ["token_ws"]);
`` ''

 <strong> getTransactionResult parameters </strong>

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> |Token of the transaction. Length: 64.

 <strong> getTransactionResult response </strong>

java
WsTransactionDetailOutput output = result.getDetailOutput (). Get (0);
if (output.getResponseCode () == 0) {
    // Subscription successful, you can process the result
    // with the content of the result and output variables.
    result.getBuyOrder ();
    result.getSessionId ();
    result.getCardDetail (). getCardNumber ();
    result.getCardDetail (). getCardExpirationDate ();
    result.getAccountingDate ();
    result.getTransactionDate ();
    result.getVci ();
    result.getUrlRedirection ();
    output.getAuthorizationCode ();
    output.getPaymentType ();
    output.getAmount ();
    output.getSharesNumber ();
    output.getCommerceCode ();
    output.getBuyOrder ();
`` ''

`` `php
EARRING
`` ''

csharp
transactionResultOutput result =
    transaction.getTransactionResult (Request.Form ["token_ws"]);
wsTransactionDetailOutput output = result.detailOutput [0];
if (output.responseCode == 0) {
    // Subscription successful, you can process the result with the
    // content of the result and output variables.
    result.buyOrder;
    result.sessionId;
    result.cardDetail.cardNumber;
    result.cardDetail.cardExpirationDate;
    result.accountingDate;
    result.transactionDate;
    result.VCI;
    result.urlRedirection;
    output.authorizationCode;
    output.paymentTypeCode;
    output.amount;
    output.sharesNumber;
    output.commerceCode;
    output.buyOrder;
`` ''

Name <br> <i> type </i> | Description
------   | -----------
buyOrder <br> <i> xs: string </i> | Purchase order from the store indicated in `initTransaction ()`. Maximum length: 26
sessionId <br> <i> xs: string </i> |Session identifier, the same one originally sent by the merchant in `initTransaction ()`. Maximum length: 61.
cardDetails <br> <i> carddetails </i> | Object that represents the cardholder's credit card data.
cardDetails.cardNumber <br> <i> xs: string </i> |Last 4 numbers of the cardholder's credit card. Only for merchants authorized by Transbank the full number is sent. Maximum length: 16.
cardDetails.cardExpirationDate <br> <i> xs: string </i> |(Optional) Expiration date of the cardholder's credit card. YYMM format Only for businesses authorized by Transbank. Maximum length: 4
accoutingDate <br> <i> xs: string </i> | Authorization date. Length: 4, MMDD format
transactionDate <br> <i> xs: string </i> | Date and time of authorization. Length: 6, format: MMDDHHmm
VCI <br> <i> xs: string </i> | Result of cardholder authentication. It can take the value TSY (Authentication successful), TSN (Authentication failed), TO (Maximum time exceeded for authentication), ABO (Aborted authentication by cardholder), U3 (Internal authentication error), CNP (Does not participate, probably because a foreign card that does not participate in the 3DSecure program), A (Authentication attempt). It can be empty if the transaction was not authenticated. Maximum length: 3
urlRedirection <br> <i> xs: string </i> | Redirect URL for voucher display. Maximum length: 256
detailsOutput <br> <i> wsTransactionDetailOutput </i> | List with result of each of the `transactionDetails` sent in` initTransaction () `. For PatPass by Webpay you have a maximum of one item.
detailsOutput [0] .authorizationCode <br> <i> xs: string </i> | Transaction authorization code Maximum length: 6
detailsOutput [0] .paymentTypeCode <br> <i> xs: string </i> | Type of payment for the transaction. <br> VN = Normal Sale <br> Maximum length: 2
detailsOutput [0] .responseCode <br> <i> xs: string </i> | Authorization response code. Possible values: <br> 0 = Transaction approved. <br> -1 = Transaction rejection. <br> -2 = Transaction must be retried. <br> -3 = Transaction error. <br> -4 = Transaction rejection. <br> -5 = Rejection due to rate error. <br> -6 = Exceeds maximum monthly quota. <br> -7 = Exceeds daily limit per transaction. <br> -8 = Item not authorized. <br> -100 Rejection due to enrollment of PatPass by Webpay.
detailsOutput [0] .amount <br> <i> xs: decimal </i> | Amount of the transaction. Integer format for transactions in pesos and UF maximum 2 decimal places. Maximum length: 10
detailsOutput [0] .sharesNumber <br> <i> xs: int </i> | Amount of fees. Default value 0. Maximum length: 2
detailsOutput [0] .commerceCode <br> <i> xs: string </i> | Store trade code. Length: 12
detailsOutput [0] .buyOrder <br> <i> xs: string </i> | Store purchase order. Maximum length: 26

 <strong> acknowledgeTransaction () </strong>

Indicates to Webpay that the result of the transaction has been received.

 <aside class="warning">
The acknowledgeTransaction method must always be called. If the invocation is not carried out within a period of 30 seconds, Webpay will reverse the transaction, assuming that the merchant was unable to report its result, thus avoiding charging the cardholder.
 </aside>

 <strong> acknowledgeTransaction parameters </strong>

> SDKs automatically execute `acknowledgeTransaction ()` when they receive the
> response from `getTransactionResult ()`.

Name <br> <i> type </i> | Description
------   | -----------
tokenInput <br> <i> xs: string </i> | Token of the transaction. Length: 64.

 <strong> AcknowledgeTransaction Response </strong>

SDKs will throw exception inside `getTransactionResult ()` if it fails
> the `acknowledgeTransaction ()` which is executed automatically.

None.

 <aside class="warning">
In case of calling the acknowledgeTransaction method after 30 seconds of
Once the authorization has occurred, the exception described below will be reported and the
The merchant must not deliver product or service, since the transaction has been
Reversed by Webpay: Timeout error (Transactions REVERSED) with code 277.
 </aside>
